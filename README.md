# CRPC

A simple RPC frame work made in C++20

## 3rdparty

- [cereal](https://github.com/USCiLab/cereal) for serialize and deserialize
- [asio](https://think-async.com/Asio) for network

## 设计思路

### 注册中心设计

#### 服务端：

- **服务端启动**:

    - 发送RPC_SERVER_ONLINE到注册中心 内容目前所有服务 然后接受RPC_SERVER_ONLINE_RESPONSE响应
    - 启动对注册中心的发送协程 用于发送心跳包响应、注册请求
    - 启动对注册中心的接收协程 用于接收注册中心的心跳包 每次接受到心跳包后，将心跳包响应push到待发送列表

- **服务端注册服务上线下线**：
    - push RPC_REGISTER_SERVICE到待发送列表 内容为服务名、服务上线还是下线

- **注册中心断连**
  - 如果发现注册中心断连，则注册/注销服务抛出异常，但是不会影响客户端的rpc请求

#### 客户端：

- **客户端启动**：
    - 发送RPC_CLIENT_ONLINE到注册中心 内容为当前订阅的服务列表
    - 然后接受RPC_CLIENT_ONLINE_RESPONSE响应 内容当前订阅的服务的在线信息

    - 启动对注册中心的发送协程 用于向注册中心发送心跳包和订阅/取消订阅服务发现
    - 启动对注册中心的接收协程 用于接收注册中心的心跳包响应和订阅的服务上下线通知
    
- **客户端订阅/取消订阅某项服务发现**：
    - push RPC_(UN)SUBSCRIBE_SERVICE_DISCOVER到待发送列表 内容为服务名

- **注册中心断连**
  - 注册中心断连，则发送通知（通过用户注册一个回调的方式），并且不再更新服务列表，而是使用本地缓存的服务列表**

- **连接池**
  - 连接池客户端负责维护一个固定大小的连接池，每个连接池是一个普通的客户端
  - 整个连接池客户端公用一个io_context
  - 根据本地的服务列表和负载均衡策略，选择服务端进行调用，如果服务端未连接，则新建服务端会话并加入连接池，否则直接使用连接池中的会话

#### 注册中心：

- **启动**：
    - 启动连接接受协程
    
- **连接接受协程**：
    - 接受连接，然后接受一个包
    - 如果是RPC_SERVER_ONLINE，那么首先处理内容中的服务信息，然后启动服务端的接受协程和发送协程
    - 如果是RPC_CLIENT_ONLINE，那么首先处理内容中的服务订阅发现信息，然后启动客户端的接受协程和发送协程
    - 如果超时则结束连接

- **服务端接受协程**：
    - 接受服务端的心跳包响应
    - 接受服务端的服务上下线通知，然后根据客户端的订阅信息，push服务上下线通知到客户端的待发送列表

- **服务端发送协程**：
    - 定时发送心跳包，如果超时则删除服务端，结束服务端

- **客户端接受协程**：
    - 接受客户端的心跳包
    - 接受客户端的订阅/取消订阅服务发现，修改本地的客户端订阅信息，然后如果需要的情况下（订阅），push服务上下线通知到客户端的待发送列表，如果取消订阅则只需客户端自己删除他的缓存

- **客户端发送协程**：
    - 发送心跳包响应和服务上下线通知响应

    




