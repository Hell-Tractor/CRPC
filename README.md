# CRPC

基于ASIO与C++20协程的玩具级分布式RPC框架
灵感启发：[C++20协程实现简单RPC框架](https://zhuanlan.zhihu.com/p/460646015)

## 3rdparty

- [cereal](https://github.com/USCiLab/cereal) 用于序列化
- [asio](https://think-async.com/Asio) 用于网络通信和异步

## 为什么（选题动力）

- 主要基于兴趣开发
- 对C++20新特性中的无栈协程感兴趣
- 对asio网络库的使用感兴趣
- 进一步了解C++中的异步并发编程
- 了解如何设计典型的RPC框架以及如何在框架基础上实现分布式

## 怎么做的（设计思路）

### 基础设计

#### 使用方式：

- header only，只需要include头文件到项目中即可使用，无需编译
- 依赖的asio和cereal库都是header only

#### 网络：

- 使用asio库实现TCP连接
- 使用自定义的协议发送通信包，格式为：请求类型（1字节）、请求序列号（4字节）、请求长度（4字节）、请求内容

#### 异步、并发操作：
- 使用asio封装的C++20协程实现异步
- 服务器、客户端、注册中心都各自运行在一个单独的线程上，单个线程内包含多个协程
- 大部分情况下使用一个queue的多生产者-单消费者模型，由于是协程所以不需要加锁

#### 序列化：
- 使用cereal库实现序列化，序列化为json格式的字符串，支持大部分C++标准库内的数据结构，支持自定义序列化

### 单服务端设计

#### 服务端：

- **启动**
    - 启动连接接受协程
- **连接接受协程**
    - 接受客户端的连接
    - 对每个连接启动一个会话，包括客户端接受协程和客户端发送协程
- **客户端会话接受协程**
    - 接受客户端的rpc调用请求，对每个请求，如果是同步调用则直接调用并将响应加入待发送列表，如果是协程异步调用则生成一个协程调用
- **客户端会话发送协程**
    - 发送待发送列表中的响应 

#### 客户端：
- **连接服务端**
    - 连接服务端，然后启动客户端接受协程和客户端发送协程

- **客户端接受协程**
    - 接受服务端的响应，并且设置对应的promise的值

- **客户端发送协程**
    - 发送待发送列表中的rpc请求

- **异步调用**
    - 将rpc请求加入待发送列表，然后返回一个future，当客户端接受协程接受到响应后，设置future的值
    - 生成一个协程用于检测调用超时
- **同步调用**
    - 异步调用返回的future直接调用get进行阻塞

### 分布式设计

#### 服务端：

- **服务端启动**:

    - 发送RPC_SERVER_ONLINE到注册中心 内容目前所有服务 然后接受RPC_SERVER_ONLINE_RESPONSE响应
    - 启动对注册中心的发送协程 用于发送心跳包响应、注册请求
    - 启动对注册中心的接收协程 用于接收注册中心的心跳包 每次接受到心跳包后，将心跳包响应push到待发送列表

- **服务端注册服务上线下线**：
    - push RPC_REGISTER_SERVICE到待发送列表 内容为服务名、服务上线还是下线

- **注册中心断连**
  - 如果发现注册中心断连，则注册/注销服务抛出异常，但是不会影响客户端的rpc请求

#### 客户端：

- **客户端启动**：
    - 发送RPC_CLIENT_ONLINE到注册中心 内容为当前订阅的服务列表
    - 然后接受RPC_CLIENT_ONLINE_RESPONSE响应 内容当前订阅的服务的在线信息

    - 启动对注册中心的发送协程 用于向注册中心发送心跳包和订阅/取消订阅服务发现
    - 启动对注册中心的接收协程 用于接收注册中心的心跳包响应和订阅的服务上下线通知
    
- **客户端订阅/取消订阅某项服务发现**：
    - push RPC_(UN)SUBSCRIBE_SERVICE_DISCOVER到待发送列表 内容为服务名

- **注册中心断连**
  - 注册中心断连，则发送通知（通过用户注册一个回调的方式），并且不再更新服务列表，而是使用本地缓存的服务列表**

- **连接池**
  - 连接池客户端负责维护一个固定大小的连接池，每个连接池是一个普通的客户端
  - 整个连接池客户端公用一个io_context
  - 根据本地的服务列表和负载均衡策略，选择服务端进行调用，如果服务端未连接，则新建服务端会话并加入连接池，否则直接使用连接池中的会话

#### 注册中心：

- **启动**：
    - 启动连接接受协程
    
- **连接接受协程**：
    - 接受连接，然后接受一个包
    - 如果是RPC_SERVER_ONLINE，那么首先处理内容中的服务信息，发送RPC_SERVER_ONLINE_RESPONSE，然后启动服务端的接受协程和发送协程
    - 如果是RPC_CLIENT_ONLINE，那么首先处理内容中的服务发现订阅，发送RPC_CLIENT_ONLINE_RESPONSE，内容为客户端订阅的服务信息，然后启动客户端的接受协程和发送协程
    - 如果超时则结束连接

- **服务端接受协程**：
    - 接受服务端的心跳包响应
    - 接受服务端的服务上下线通知，然后根据客户端的订阅信息，push服务上下线通知到客户端的待发送列表

- **服务端发送协程**：
    - 定时发送心跳包，如果超时则删除服务端，结束服务端

- **客户端接受协程**：
    - 接受客户端的心跳包
    - 接受客户端的订阅/取消订阅服务发现，修改本地的客户端订阅信息，然后如果需要的情况下（订阅），push服务上下线通知到客户端的待发送列表，如果取消订阅则只需客户端自己删除他的缓存

- **客户端发送协程**：
    - 发送心跳包响应和服务上下线通知响应